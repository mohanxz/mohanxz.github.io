<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aromahut - Checkout</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta content="" name="keywords" />
  <meta content="" name="description" />

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet" />

  <!-- Icon Font Stylesheet -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Libraries Stylesheet -->
  <link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet" />
  <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

  <!-- Customized Bootstrap Stylesheet -->
  <link href="css/bootstrap.min.css" rel="stylesheet" />

  <!-- Template Stylesheet -->
  <link href="css/style.css" rel="stylesheet" />

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  
  <style>
    :root {
      --primary-orange: #ff6b00;
      --dark-orange: #e05a00;
      --primary-blue:#1F75FE;
      --light-orange: #ff8c00;
      --gold-accent: #ffd700;
      --spice-gradient: linear-gradient(135deg, #ff6b00, #ff8c00, #ffaa00);
      --trust-gradient: linear-gradient(135deg, #1F75FE, #3C8DFF, #66A6FF);

      --light-gray: #f8f9fa;
      --medium-gray: #e9ecef;
      --dark-gray: #393b3c;
    }
    
    /* Base Styles */
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Raleway', sans-serif;
    }
    
    /* Checkout Container */
    .checkout-container {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      margin: 20px auto;
      padding: 30px;
      position: relative;
      max-width: 1400px;
      top: -40px;
    }
    
    /* Form Styles */
    .form-label {
      font-weight: 600;
      color: var(--dark-gray);
    }
    
    .form-control {
      border: 1px solid var(--medium-gray);
      border-radius: 5px;
      padding: 10px 15px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: var(--primary-orange);
      box-shadow: 0 0 0 0.25rem rgba(255, 107, 0, 0.25);
    }
    
          /* Luxurious Orange Theme Scrollbar */
      ::-webkit-scrollbar {
          width: 12px;
          height: 12px;
      }
      
      ::-webkit-scrollbar-track {
          background: #fff5e6; /* Light orange background */
          border-radius: 10px;
          box-shadow: inset 0 0 5px rgba(255, 165, 0, 0.1);
      }
      
      ::-webkit-scrollbar-thumb {
          background: linear-gradient(135deg, #ff8c00, #ff6b00, #ff4500);
          border-radius: 10px;
          border: 2px solid #fff5e6;
          box-shadow: inset 0 0 3px rgba(255, 255, 255, 0.3);
          transition: all 0.3s ease;
      }
      
      ::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(135deg, #ff4500, #ff6b00, #ff8c00);
          box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.4);
      }
      
      ::-webkit-scrollbar-corner {
          background: #fff5e6;
      }
      
      /* For Firefox */
      * {
          scrollbar-width: thin;
          scrollbar-color: #ff6b00 #fff5e6;
      }
      
      /* Smooth scrolling effect */
      html {
          scroll-behavior: smooth;
      }
      
      /* Scroll glow effect */
      .scrolling-glow {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(90deg, #ff8c00, #ff6b00, #ff4500);
          z-index: 9999;
          transform-origin: 0 0;
          transform: scaleX(0);
          transition: transform 0.2s ease-out;
          box-shadow: 0 0 10px rgba(255, 107, 0, 0.7);
      }

    /* Cart Summary */
    .cart-summary {
      background-color: var(--light-gray);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .cart-summary h3 {
      color: var(--primary-orange);
      font-weight: 700;
      margin-bottom: 20px;
    }
    
    /* Table Styles */
    table.table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    table.table thead tr {
      background: var(--spice-gradient);
      color: white;
    }
    
    table.table th {
      padding: 15px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    
    table.table td {
      padding: 15px;
      vertical-align: middle;
      border-bottom: 1px solid var(--medium-gray);
    }
    
    /* Quantity Controls */
    .quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      left: -30px;
    }
    
    .quantity-control button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--primary-orange);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      color: white;
      font-size: 14px;
      margin: 0 5px;
    }
    
    .quantity-control button:hover {
      background: var(--dark-orange);
      transform: scale(1.1);
    }
    
    /* Checkout Button */
.checkout-btn {
  background: white;
  border: 2px solid var(--primary-blue) !important;
  color: var(--primary-blue) !important;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  padding: 12px 30px !important;
  border-radius: 50px !important;
  text-transform: uppercase;
  font-size: 0.9rem;
  width: 100%;
  margin-top: 20px;
  position: relative;
  overflow: hidden;
}

.checkout-btn::before {
  content: "";
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: linear-gradient(
    120deg,
    transparent,
    rgba(255, 255, 255, 0.4),
    transparent
  );
  transform: skewX(-20deg);
  transition: all 0.5s ease;
}

.checkout-btn:hover::before {
  left: 125%;
}

.checkout-btn:hover {
  background: var(--trust-gradient) !important;
  color: white !important;
  border-color: transparent !important;
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(31, 117, 254, 0.3);
}

/* Trust Message */
.payment-trust {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.85rem;
  color: #075e1b;
  font-weight: 800;
  margin-top: 10px;
  justify-content: center;
}

.tick-icon {
  flex-shrink: 0;
}

    /* Validation Styles */
    .is-invalid {
      border-color: #dc3545 !important;
    }
    
    .invalid-feedback {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    
    /* Layout Adjustments */
    .checkout-form-section {
      padding-right: 40px;
      height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    .cart-summary-container {
      position: sticky;
      top: 20px;
      height: fit-content;
    }
    
    /* Responsive Styles */
    @media (max-width: 991.98px) {
      .checkout-form-section {
        height: auto;
        overflow: visible;
        padding-right: 15px;
      }
      
      .cart-summary-container {
        position: static;
      }
    }
    
    @media (max-width: 767.98px) {
      .checkout-container {
        padding: 15px;
      }
      
      table.table thead {
        display: none;
      }
      
      table.table tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid var(--medium-gray);
        border-radius: 10px;
      }
      
      table.table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      table.table td:before {
        content: attr(data-label);
        font-weight: bold;
        margin-right: 15px;
        color: var(--dark-gray);
        flex: 1;
      }
    }
    input{
      border: solid 1px rgb(255, 116, 9) !important;
    }
    th.qty {
  padding-left: 20px !important;
  text-align: left !important;
}

td.qty {
  padding-left: 20px !important;
  text-align: left !important;
}

   
  </style>
</head>

<body>
  <!-- Spinner -->
  <div id="spinner" class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" role="status"></div>
  </div>

  <!-- Checkout Page Content -->
  <div class="container-fluid py-5 ">
    <div class="container py-5 checkout-container">
      <h1 class="mb-4">Billing details</h1>
      <form id="billing-form">
        <div class="row g-5">
          <!-- Checkout Form Section -->
          <div class="col-md-12 col-lg-6 checkout-form-section">
            <div class="row">
              <div class="col-md-12 col-lg-6">
                <div class="form-item w-100">
                  <label class="form-label my-3">First Name<sup>*</sup></label>
                  <input type="text" class="form-control" name="first-name" required />
                  <div class="invalid-feedback">Please enter your first name</div>
                </div>
              </div>
              <div class="col-md-12 col-lg-6">
                <div class="form-item w-100">
                  <label class="form-label my-3">Last Name<sup>*</sup></label>
                  <input type="text" class="form-control" name="last-name" required />
                  <div class="invalid-feedback">Please enter your last name</div>
                </div>
              </div>
            </div>
            
            <div class="form-item">
              <label class="form-label my-3">Address <sup>*</sup></label>
              <input type="text" class="form-control" name="address" placeholder="House Number Street Name" required />
              <div class="invalid-feedback">Please enter your address</div>
            </div>
            
            <div class="form-item">
              <label class="form-label my-3">Town/City<sup>*</sup></label>
              <input type="text" class="form-control" name="town-city" placeholder="Town/City" required />
              <div class="invalid-feedback">Please enter your city</div>
            </div>
            
            <div class="form-item">
              <label class="form-label my-3">state<sup>*</sup></label>
              <input type="text" class="form-control" name="state" required />
              <div class="invalid-feedback">Please enter your state</div>
            </div>
            
            <div class="form-item">
              <label class="form-label my-3">Postcode/Zip<sup>*</sup></label>
              <input type="text" class="form-control" name="postcode" required />
              <div class="invalid-feedback">Please enter your postcode</div>
            </div>
            
            <div class="form-item">
              <label class="form-label my-3">Mobile<sup>*</sup></label>
              <input type="tel" class="form-control" name="phone-no" required pattern="[0-9]{10}" maxlength="10" />
              <div class="invalid-feedback">Please enter a valid 10-digit phone number</div>
            </div>
            
            <div class="form-item">
              <label class="form-label my-3">Email Address<sup>*</sup></label>
              <input type="email" class="form-control" name="email-id" required />
              <div class="invalid-feedback">Please enter a valid email address</div>
            </div>
            
            <div class="form-item">
              <label class="form-label my-3">Message</label>
              <textarea name="text" class="form-control" spellcheck="false" cols="30" rows="5" placeholder="Order Notes (Optional)"></textarea>
            </div>
          </div>
          
          <!-- Order Summary Section -->
          <div class="col-md-12 col-lg-6">
            <div class="cart-summary-container">
              <div class="cart-summary">
                <h3>Order Summary</h3>
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th data-label="Product">Product</th>
                        <th data-label="Weight">Weight</th>
                        <th data-label="Qty" class="qty">Qty</th>
                        <th data-label="Price">Price</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="cart-items">
                      <!-- Cart items will be inserted here -->
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="4" class="text-end text-dark">Subtotal:</td>
                        <td class="subtotal text-dark">₹0.00</td>
                      </tr>
                      <tr>
                        <td colspan="4" class="text-end text-dark">Shipping:</td>
                        <td class="shipping text-dark">₹2.00</td>
                      </tr>
                      <tr>
                        <td colspan="4" class="text-end fw-bold text-dark">Total:</td>
                        <td class="Total fw-bold text-dark">₹0.00</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
<!-- Checkout Button with Trust Message -->
<button id="rzp-button" class="checkout-btn">Proceed to Pay</button>
<span class="payment-trust">
  <svg class="tick-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#28a745" viewBox="0 0 16 16">
    <path d="M13.485 1.929a.75.75 0 0 1 1.06 1.06l-8 8a.75.75 0 0 1-1.06 0l-4-4a.75.75 0 0 1 1.06-1.06L6 8.439l7.485-7.51z"/>
  </svg>
  Your payment is safe & secure
</span>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="lib/easing/easing.min.js"></script>
  <script src="lib/waypoints/waypoints.min.js"></script>
  <script src="lib/lightbox/js/lightbox.min.js"></script>
  <script src="lib/owlcarousel/owl.carousel.min.js"></script>

  <!-- Template Javascript -->
  <script src="js/main.js"></script>
  
  <script>
    let total;
  
    $(document).ready(function () {
      // Initialize form validation
      initFormValidation();
      
      // Load cart items
      updateCartItems();
      updateSubtotal();
      updateTotal();
    });
    
    function initFormValidation() {
      // Validate form on submit
      $('#billing-form').on('submit', function(e) {
        e.preventDefault();
        if (validateForm()) {
          processPayment();
        }
      });
      
      // Real-time validation
      $('input[required]').on('blur', function() {
        validateField($(this));
      });
    }
    
    function validateField(field) {
      const value = field.val().trim();
      const feedback = field.next('.invalid-feedback');
      
      if (!value) {
        field.addClass('is-invalid');
        return false;
      }
      
      // Special validation for email
      if (field.attr('type') === 'email' && !isValidEmail(value)) {
        field.addClass('is-invalid');
        feedback.text('Please enter a valid email address');
        return false;
      }
      
      // Special validation for phone
      if (field.attr('name') === 'phone-no' && !isValidPhone(value)) {
        field.addClass('is-invalid');
        feedback.text('Please enter a valid 10-digit phone number');
        return false;
      }
      
      field.removeClass('is-invalid');
      return true;
    }
    
    function validateForm() {
      let isValid = true;
      let firstInvalidField = null;
      
      $('input[required]').each(function() {
        if (!validateField($(this))) {
          isValid = false;
          if (!firstInvalidField) {
            firstInvalidField = $(this);
          }
        }
      });
      
      // Scroll to first invalid field if any
      if (!isValid && firstInvalidField) {
        $('html, body').animate({
          scrollTop: firstInvalidField.offset().top - 100
        }, 500);
        
        setTimeout(() => {
          firstInvalidField.focus();
        }, 500);
      }
      
      return isValid;
    }
    
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    
    function isValidPhone(phone) {
      return /^\d{10}$/.test(phone);
    }
  
    function updateCartItems() {
      const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      const cartContainer = $("#cart-items");
  
      if (cartContainer.length) {
        cartContainer.empty();
        
        if (cartItems.length === 0) {
          cartContainer.append('<tr><td colspan="5" class="text-center py-4">Your cart is empty</td></tr>');
          return;
        }
        
        cartItems.forEach((item, index) => {
          item.pricePerUnit = item.pricePerUnit || parseFloat(item.price.replace("₹", "").trim());
          const itemRow = $(`
            <tr>
              <td data-label="Product" class="text-dark">${item.name}</td>
              <td data-label="Weight"  class="text-dark">${item.weight}</td>
              <td data-label="Qty">
                <div class="quantity-control">
                  <button onclick="changeQuantity(${index}, -1) ">-</button>
                  <span class="text-dark" id="quantity-${index}">${item.quantity || "1"}</span>
                  <button onclick="changeQuantity(${index}, 1)" >+</button>
                </div>
              </td>
              <td data-label="Price"  class="text-dark"id="price-${index}">₹${(item.pricePerUnit * (item.quantity || 1)).toFixed(2)}</td>
              <td><i class="fas fa-trash-alt remove-btn text-danger"  data-index="${index}"></i></td>
            </tr>
          `);
          cartContainer.append(itemRow);
        });
  
        $("#cart-items").on("click", ".fa-trash-alt", function() {
          const index = $(this).data("index");
          const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
          cartItems.splice(index, 1);
          localStorage.setItem("cartItems", JSON.stringify(cartItems));
          updateCartItems();
          updateSubtotal();
          updateTotal();
        });
      }
    }
  
    function updateSubtotal() {
      const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      total = 0;
      cartItems.forEach((item) => {
        const price = parseFloat(item.price.replace("₹", ""));
        const quantity = item.quantity || 1;
        total += price * quantity;
      });
      $(".subtotal").text(`₹${total.toFixed(2)}`);
      return total;
    }
  
    function updateTotal() {
      const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      total = 0;
      cartItems.forEach((item) => {
        const price = parseFloat(item.price.replace("₹", ""));
        const quantity = item.quantity || 1;
        total += price * quantity;
      });
  
      const shipping = 2.00; // Fixed shipping cost
      total += shipping;
  
      localStorage.setItem("total", total.toFixed(2));
      $(".Total").text(`₹${total.toFixed(2)}`);
      $(".shipping").text(`₹${shipping.toFixed(2)}`);
      
      // Disable checkout button if cart is empty
      if (cartItems.length === 0) {
        $("#rzp-button").prop("disabled", true).addClass("disabled");
      } else {
        $("#rzp-button").prop("disabled", false).removeClass("disabled");
      }
      
      return total;
    }
  
    window.changeQuantity = function(index, change) {
      const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      cartItems[index].quantity = (cartItems[index].quantity || 1) + change;
      
      // Ensure quantity doesn't go below 1
      if (cartItems[index].quantity < 1) {
        cartItems[index].quantity = 1;
      }
      
      localStorage.setItem("cartItems", JSON.stringify(cartItems));
      $(`#quantity-${index}`).text(cartItems[index].quantity);
  
      const pricePerUnit = cartItems[index].pricePerUnit || parseFloat(cartItems[index].price.replace("₹", "").trim());
      const newPrice = pricePerUnit * cartItems[index].quantity;
      $(`#price-${index}`).text(`₹${newPrice.toFixed(2)}`);
  
      updateSubtotal();
      updateTotal();
    };
    
    function processPayment() {
      // Show loading spinner
      $('#spinner').addClass('show');
      
      // Get buyer details
      const firstName = $('input[name="first-name"]').val().trim();
      const lastName = $('input[name="last-name"]').val().trim();
      const email = $('input[name="email-id"]').val().trim();
      const phone = $('input[name="phone-no"]').val().trim();
      const address = $('input[name="address"]').val().trim();
      const city = $('input[name="town-city"]').val().trim();
      const postalCode = $('input[name="postcode"]').val().trim();
      const state = $('input[name="state"]').val().trim();
      
      // Combine address details
      const fullAddress = `${address}, ${city}, ${postalCode}, ${state}`;
      
      // Get total from localStorage (includes shipping)
      const totalAmount = parseFloat(localStorage.getItem("total")) || 0;
      const amountInPaise = Math.round(totalAmount * 100); // Convert to paise
      
      // Get cart items
      const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      
      // Prepare order data
      const orderData = {
        amount: amountInPaise,
        currency: "INR",
        buyer: {
          name: `${firstName} ${lastName}`,
          email: email,
          phone: phone,
          address: fullAddress
        },
        items: cartItems.map(item => ({
          name: item.name,
          weight: item.weight,
          quantity: item.quantity || 1,
          price: parseFloat(item.price.replace("₹", ""))
        }))
      };
      
      // Create order with backend
      fetch("http://localhost:10000/create-order", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ amount: amountInPaise }),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(order => {
        // Initialize Razorpay
        const options = {
          key: "rzp_live_PJ1rolbjunHAfs",
          amount: order.amount,
          currency: "INR",
          name: "Aromahut",
          description: "Order Payment",
          image: "https://via.placeholder.com/150",
          order_id: order.id,
          handler: function(response) {
            handlePaymentSuccess(response, orderData);
          },
          prefill: {
            name: orderData.buyer.name,
            email: orderData.buyer.email,
            contact: orderData.buyer.phone
          },
          notes: {
            address: orderData.buyer.address
          },
          theme: {
            color: "#ff6b00"
          }
        };
        
        const rzp1 = new Razorpay(options);
        rzp1.open();
        
        // Hide spinner when Razorpay opens
        $('#spinner').removeClass('show');
      })
      .catch(error => {
        console.error("Error creating order:", error);
        alert("There was an error processing your payment. Please try again.");
        $('#spinner').removeClass('show');
      });
    }
    
    function handlePaymentSuccess(response, orderData) {
      // Prepare payment verification data
      const paymentData = {
        razorpay_order_id: response.razorpay_order_id,
        razorpay_payment_id: response.razorpay_payment_id,
        razorpay_signature: response.razorpay_signature,
        ...orderData
      };
      
      // Verify payment with backend
      fetch("http://localhost:5000/verify-payment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(paymentData),
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          // Clear cart on successful payment
          localStorage.removeItem("cartItems");
          localStorage.removeItem("total");
          
          // Redirect to thank you page
          window.location.href = "greetings.html";
        } else {
             window.location.href = "greetings.html";

        }
      })
      .catch(error => {
        console.error("Error verifying payment:", error);
        alert("There was an error verifying your payment. Please contact support.");
      });
    }
    
    // Attach click handler to payment button
    $("#rzp-button").click(function(e) {
      e.preventDefault();
      if (validateForm()) {
        processPayment();
      }
    });
  </script>
</body>
</html>